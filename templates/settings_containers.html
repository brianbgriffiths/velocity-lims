{% extends 'index.html' %}
{% load static %}
{% block title %}Velocity LIMS - Container Types{% endblock %}
{% block headdata %}
<script src="{% static 'js/pylims_common.js' %}"></script>
<script src="{% static 'js/pylims_request.js' %}"></script>
<script src="{% static 'js/pylims_ui.js' %}"></script>
<link rel="stylesheet" href="{% static 'css/pylims_ui.css' %}">
<style>
    .container-management {
        display: flex;
        gap: 20px;
        height: calc(100vh - 150px);
        min-height: 600px;
    }
    
    .left-panel {
        flex: 0 0 400px;
        background-color: var(--gray-lightest);
        border: solid 1px var(--gray-med);
        border-radius: 3px;
        display: flex;
        flex-direction: column;
    }
    
    .right-panel {
        flex: 1;
        background-color: var(--gray-lightest);
        border: solid 1px var(--gray-med);
        border-radius: 3px;
        display: flex;
        flex-direction: column;
    }
    
    .panel-header {
        background-color: var(--accent1);
        color: white;
        padding: 12px;
        font-weight: bold;
        border-radius: 3px 3px 0 0;
        font-size: 14px;
    }
    
    .panel-content {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
    }
    
    .container-type-list {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
    
    .container-type-item {
        background-color: white;
        border: solid 1px var(--gray-light);
        border-radius: 3px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .container-type-item:hover {
        background-color: var(--accent9);
        border-color: var(--accent3);
    }
    
    .container-type-item.selected {
        background-color: var(--accent8);
        border-color: var(--accent1);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .container-type-name {
        font-weight: bold;
        font-size: 14px;
        color: var(--text-color);
        margin-bottom: 4px;
    }
    
    .container-type-details {
        font-size: 12px;
        color: var(--gray-dark);
    }
    
    .no-container-types {
        text-align: center;
        padding: 40px 20px;
        color: var(--gray-med);
        font-style: italic;
        font-size: 14px;
    }
    
    .btn-create {
        background-color: var(--green-med);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
        width: 100%;
        margin-top: 10px;
    }
    
    .btn-create:hover {
        background-color: var(--green-dark);
    }
    
    .btn-delete {
        background-color: var(--red-med);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 11px;
        font-weight: bold;
        margin-top: 10px;
    }
    
    .btn-delete:hover {
        background-color: var(--red-dark);
    }
    
    .create-form {
        background-color: white;
        border: solid 1px var(--gray-med);
        border-radius: 3px;
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: var(--text-color);
        font-size: 12px;
    }
    
    .form-input {
        width: 100%;
        padding: 8px;
        border: solid 1px var(--gray-med);
        border-radius: 3px;
        font-size: 14px;
        box-sizing: border-box;
    }
    
    .form-input:focus {
        border-color: var(--accent3);
        outline: none;
    }
    
    .form-row {
        display: flex;
        gap: 10px;
    }
    
    .form-row .form-group {
        flex: 1;
    }
    
    .form-select {
        width: 100%;
        padding: 8px;
        border: solid 1px var(--gray-med);
        border-radius: 3px;
        font-size: 14px;
        background-color: white;
        box-sizing: border-box;
    }
    
    .plate-preview {
        background-color: white;
        border: solid 1px var(--gray-med);
        border-radius: 3px;
        padding: 20px;
    }
    
    .plate-grid {
        display: inline-block;
        border: 2px solid var(--gray-dark);
        border-radius: 5px;
        padding: 10px;
        background-color: #f8f9fa;
        margin: 20px auto;
    }
    
    .plate-grid table {
        border-collapse: separate;
        border-spacing: 2px;
        margin: 0;
    }
    
    .plate-grid th,
    .plate-grid td {
        width: 25px;
        height: 25px;
        text-align: center;
        vertical-align: middle;
        font-size: 10px;
        font-weight: bold;
        border: 1px solid var(--gray-med);
        border-radius: 2px;
        padding: 0;
    }
    
    .plate-grid th {
        background-color: var(--gray-lightest);
        color: var(--gray-dark);
    }
    
    .plate-grid .well {
        background-color: white;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .plate-grid .well:hover {
        background-color: var(--accent9);
    }
    
    .plate-grid .well.restricted {
        background-color: var(--red-lightest);
        border-color: var(--red-med);
    }
    
    .plate-grid .well.special {
        background-color: var(--blue-lightest);
        border-color: var(--blue-med);
    }
    
    /* Color options for plate styles */
    .color-option {
        display: inline-block;
        width: 30px;
        height: 30px;
        border-radius: 3px;
        border: 2px solid var(--gray-med);
        margin-right: 5px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .color-option.selected {
        border-color: var(--accent1);
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
    }
    
    .color-option.color-1 { background-color: #ffffff; }
    .color-option.color-2 { background-color: #f8f9fa; }
    .color-option.color-3 { background-color: #e9ecef; }
    .color-option.color-4 { background-color: #dee2e6; }
    .color-option.color-5 { background-color: #adb5bd; }
    .color-option.color-6 { background-color: #6c757d; }
    .color-option.color-7 { background-color: #495057; }
    .color-option.color-8 { background-color: #343a40; }
    .color-option.color-9 { background-color: #212529; }
    .color-option.color-10 { background-color: #000000; }
    
    .well-type-preview {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }
    
    .well-sample {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: 2px solid var(--gray-med);
    }
    
    .well-type-1 { border-radius: 50%; }  /* Round */
    .well-type-2 { border-radius: 0; }    /* Square */
    .well-type-3 { border-radius: 15%; }  /* Rounded square */
    
    .border-type-1 { border-width: 1px; }
    .border-type-2 { border-width: 2px; }
    .border-type-3 { border-width: 3px; }
    
    #pylims_request_error {
        border: solid 1px var(--red-med);
        color: var(--red-dark);
        background-color: var(--red-light);
        padding: 10px;
        border-radius: 3px;
        display: none;
        margin: 10px 0px;
    }
    
    #pylims_request_success {
        border: solid 1px var(--green-med);
        color: var(--green-dark);
        background-color: var(--green-light);
        padding: 10px;
        border-radius: 3px;
        display: none;
        margin: 10px 0px;
    }
    
    #pylims_requests_messages {
        height: 30px;
    }
</style>
{% endblock %}

{% block centercontent %}
<div id="main" class="center-border">
    <breadcrumbs>
        <a href="{% url 'view_settings' %}">Settings</a> > 
        Container Types
    </breadcrumbs>
    
    <div id="pylims_requests_messages">
        <div id="pylims_request_error"></div>
        <div id="pylims_request_success"></div>
    </div>

    {% if error %}
        <div class="error-message">{{ error }}</div>
    {% endif %}
    
    <div class="container-management">
        <div class="left-panel">
            <div class="panel-header">
                <i class="fas fa-layer-group"></i> Container Types
            </div>
            <div class="panel-content">
                {% if has_container_types %}
                    <div class="container-type-list" id="containerTypeList">
                        {% for type in container_types %}
                            <div class="container-type-item" data-cid="{{ type.cid }}" onclick="selectContainerType({{ type.cid }}, '{{ type.type_name|escapejs }}')">
                                <div class="container-type-name">{{ type.type_name }}</div>
                                <div class="container-type-details">{{ type.rows }}×{{ type.columns }} wells</div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="no-container-types">
                        No container types have been created yet.
                    </div>
                {% endif %}
                
                {% if can_create %}
                    <button class="btn-create" onclick="showCreateForm()">
                        <i class="fas fa-plus"></i> Create New Container Type
                    </button>
                {% endif %}
            </div>
        </div>
        
        <div class="right-panel">
            <div class="panel-header">
                <i class="fas fa-plus"></i> Create Container Type
            </div>
            <div class="panel-content">
                <div class="create-form">
                    <form id="createContainerForm" onsubmit="createContainerType(event)">
                        <div class="form-group">
                            <label class="form-label" for="typeName">Container Type Name *</label>
                            <input type="text" id="typeName" class="form-input" placeholder="e.g., 96-well PCR Plate" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="rows">Rows *</label>
                                <input type="number" id="rows" class="form-input" min="1" max="50" value="8" onchange="updatePreview()">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="columns">Columns *</label>
                                <input type="number" id="columns" class="form-input" min="1" max="50" value="12" onchange="updatePreview()">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="wellType">Well Type</label>
                                <select id="wellType" class="form-select" onchange="updatePreview()">
                                    <option value="1">Round wells</option>
                                    <option value="2">Square wells</option>
                                    <option value="3">Rounded square wells</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="borderType">Border Style</label>
                                <select id="borderType" class="form-select" onchange="updatePreview()">
                                    <option value="1">Thin border</option>
                                    <option value="2">Medium border</option>
                                    <option value="3">Thick border</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Plate Color</label>
                            <div id="colorOptions">
                                <div class="color-option color-1 selected" data-color="1" onclick="selectColor(1)"></div>
                                <div class="color-option color-2" data-color="2" onclick="selectColor(2)"></div>
                                <div class="color-option color-3" data-color="3" onclick="selectColor(3)"></div>
                                <div class="color-option color-4" data-color="4" onclick="selectColor(4)"></div>
                                <div class="color-option color-5" data-color="5" onclick="selectColor(5)"></div>
                                <div class="color-option color-6" data-color="6" onclick="selectColor(6)"></div>
                                <div class="color-option color-7" data-color="7" onclick="selectColor(7)"></div>
                                <div class="color-option color-8" data-color="8" onclick="selectColor(8)"></div>
                                <div class="color-option color-9" data-color="9" onclick="selectColor(9)"></div>
                                <div class="color-option color-10" data-color="10" onclick="selectColor(10)"></div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <button type="submit" class="btn-create">
                                <i class="fas fa-save"></i> Create Container Type
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="plate-preview">
                    <h4 style="margin-top: 0;">Preview</h4>
                    <div id="platePreview" style="text-align: center;">
                        <!-- Preview will be generated here -->
                    </div>
                </div>
                
                <div id="selectedTypeDetails" style="display: none;">
                    <h4>Selected Container Type</h4>
                    <div id="selectedTypeInfo"></div>
                    {% if can_archive %}
                        <button class="btn-delete" onclick="deleteContainerType()">
                            <i class="fas fa-trash"></i> Delete Container Type
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script>
const csrf = '{{ csrf_token }}';
let selectedContainerTypeId = null;
let selectedColor = 1;

function updatePreview() {
    const rows = parseInt(document.getElementById('rows').value) || 8;
    const columns = parseInt(document.getElementById('columns').value) || 12;
    const wellType = parseInt(document.getElementById('wellType').value) || 1;
    const borderType = parseInt(document.getElementById('borderType').value) || 1;
    
    generatePlatePreview(rows, columns, wellType, borderType, selectedColor);
}

function generatePlatePreview(rows, columns, wellType, borderType, color) {
    const preview = document.getElementById('platePreview');
    
    let html = '<div class="plate-grid">';
    html += '<table>';
    
    // Header row with column numbers
    html += '<tr><th></th>';
    for (let col = 1; col <= columns; col++) {
        html += `<th>${col}</th>`;
    }
    html += '</tr>';
    
    // Data rows
    for (let row = 0; row < rows; row++) {
        const rowLabel = String.fromCharCode(65 + row); // A, B, C, etc.
        html += '<tr>';
        html += `<th>${rowLabel}</th>`;
        
        for (let col = 1; col <= columns; col++) {
            const wellId = rowLabel + col;
            html += `<td class="well well-type-${wellType} border-type-${borderType} color-${color}" 
                        data-well="${wellId}" onclick="toggleWell('${wellId}')">${wellId}</td>`;
        }
        html += '</tr>';
    }
    
    html += '</table>';
    html += '</div>';
    
    preview.innerHTML = html;
}

function toggleWell(wellId) {
    const well = document.querySelector(`[data-well="${wellId}"]`);
    if (well.classList.contains('restricted')) {
        well.classList.remove('restricted');
        well.classList.add('special');
    } else if (well.classList.contains('special')) {
        well.classList.remove('special');
    } else {
        well.classList.add('restricted');
    }
}

function selectColor(colorNumber) {
    // Update selected color
    document.querySelectorAll('.color-option').forEach(option => {
        option.classList.remove('selected');
    });
    document.querySelector(`[data-color="${colorNumber}"]`).classList.add('selected');
    
    selectedColor = colorNumber;
    updatePreview();
}

function selectContainerType(cid, typeName) {
    selectedContainerTypeId = cid;
    
    // Update selected state
    document.querySelectorAll('.container-type-item').forEach(item => {
        item.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');
    
    // Load container type details
    loadContainerTypeDetails(cid);
    
    // Show details section
    document.getElementById('selectedTypeDetails').style.display = 'block';
}

function loadContainerTypeDetails(cid) {
    const pyoptions = {
        data: { cid: cid },
        csrf: csrf,
        url: 'get_container_type_details/',
        submit_mode: 'silent'
    };
    
    pylims_post(pyoptions).then(result => {
        if (result.status === 'success') {
            const type = result.container_type;
            
            // Update details display
            let html = `<p><strong>Name:</strong> ${type.type_name}</p>`;
            html += `<p><strong>Dimensions:</strong> ${type.rows} × ${type.columns} wells</p>`;
            html += `<p><strong>Well Type:</strong> ${getWellTypeName(type.well_type)}</p>`;
            html += `<p><strong>Border:</strong> ${getBorderTypeName(type.border_type)}</p>`;
            
            document.getElementById('selectedTypeInfo').innerHTML = html;
            
            // Generate preview for this container type
            generatePlatePreview(type.rows, type.columns, type.well_type, type.border_type, type.color);
        }
    }).catch(error => {
        console.error('Error loading container type details:', error);
        pylims_ui.error('Failed to load container type details');
    });
}

function getWellTypeName(wellType) {
    const types = { 1: 'Round wells', 2: 'Square wells', 3: 'Rounded square wells' };
    return types[wellType] || 'Unknown';
}

function getBorderTypeName(borderType) {
    const types = { 1: 'Thin border', 2: 'Medium border', 3: 'Thick border' };
    return types[borderType] || 'Unknown';
}

function showCreateForm() {
    // Reset form
    document.getElementById('createContainerForm').reset();
    selectedColor = 1;
    document.querySelectorAll('.color-option').forEach(option => {
        option.classList.remove('selected');
    });
    document.querySelector('[data-color="1"]').classList.add('selected');
    
    // Update preview
    updatePreview();
    
    // Hide details section
    document.getElementById('selectedTypeDetails').style.display = 'none';
    selectedContainerTypeId = null;
    
    // Remove selected state from list
    document.querySelectorAll('.container-type-item').forEach(item => {
        item.classList.remove('selected');
    });
}

function createContainerType(event) {
    event.preventDefault();
    
    const typeName = document.getElementById('typeName').value.trim();
    const rows = parseInt(document.getElementById('rows').value);
    const columns = parseInt(document.getElementById('columns').value);
    const wellType = parseInt(document.getElementById('wellType').value);
    const borderType = parseInt(document.getElementById('borderType').value);
    
    if (!typeName) {
        pylims_ui.error('Container type name is required');
        return;
    }
    
    // Collect restricted and special wells
    const restrictedWells = [];
    const specialWells = [];
    
    document.querySelectorAll('.well.restricted').forEach(well => {
        restrictedWells.push(well.dataset.well);
    });
    
    document.querySelectorAll('.well.special').forEach(well => {
        specialWells.push(well.dataset.well);
    });
    
    const pyoptions = {
        data: {
            type_name: typeName,
            rows: rows,
            columns: columns,
            well_type: wellType,
            border_type: borderType,
            color: selectedColor,
            restricted_wells: restrictedWells,
            special_wells: specialWells
        },
        csrf: csrf,
        url: 'create_container_type/',
        submit_mode: 'silent'
    };
    
    pylims_post(pyoptions).then(result => {
        if (result.status === 'success') {
            pylims_ui.success(result.message);
            
            // Add new container type to list
            const listHtml = `
                <div class="container-type-item" data-cid="${result.container_type.cid}" 
                     onclick="selectContainerType(${result.container_type.cid}, '${result.container_type.type_name}')">
                    <div class="container-type-name">${result.container_type.type_name}</div>
                    <div class="container-type-details">${result.container_type.rows}×${result.container_type.columns} wells</div>
                </div>
            `;
            
            const listContainer = document.getElementById('containerTypeList');
            if (listContainer) {
                listContainer.insertAdjacentHTML('beforeend', listHtml);
            } else {
                // Replace "no container types" message
                location.reload();
            }
            
            // Reset form
            showCreateForm();
        }
    }).catch(error => {
        console.error('Error creating container type:', error);
        pylims_ui.error('Failed to create container type');
    });
}

function deleteContainerType() {
    if (!selectedContainerTypeId) {
        pylims_ui.error('No container type selected');
        return;
    }
    
    if (!confirm('Are you sure you want to delete this container type? This action cannot be undone.')) {
        return;
    }
    
    const pyoptions = {
        data: { cid: selectedContainerTypeId },
        csrf: csrf,
        url: 'delete_container_type/',
        submit_mode: 'silent'
    };
    
    pylims_post(pyoptions).then(result => {
        if (result.status === 'success') {
            pylims_ui.success(result.message);
            
            // Remove from list
            const item = document.querySelector(`[data-cid="${selectedContainerTypeId}"]`);
            if (item) {
                item.remove();
            }
            
            // Reset form and selection
            showCreateForm();
        }
    }).catch(error => {
        console.error('Error deleting container type:', error);
        pylims_ui.error('Failed to delete container type');
    });
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    updatePreview();
    console.log('Container types page loaded');
});
</script>
{% endblock %}
