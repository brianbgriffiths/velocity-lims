{% extends 'index.html' %}
{% load static %}
{% block title %}Velocity LIMS - Settings{% endblock %}
{% block headdata %}
<script src="{% static 'js/pylims_common.js' %}"></script>
<script src="{% static 'js/pylims_request.js' %}"></script>
<script src="{% static 'js/pylims_ui.js' %}"></script>
<link rel="stylesheet" href="{% static 'css/pylims_ui.css' %}">
<style>
    body {
        counter-reset: sample control;
    }
    breadcrumbs {
        border:solid 1px #000000;
        padding:3px;
        display:block;
        margin-bottom:15px;
    }
	protocol {
		background-color:var(--accent1);
		color:white;
		display:block;
		position:relative;
		border-radius:3px;
		padding:3px 10px;
	}
	queue {
		background-color:var(--gray-lightest);
		color:black;
		display:block;
		position:relative;
		border-radius:3px;
		padding:3px 10px;
		margin-left:30px;
		margin-bottom:2px;
		margin-top:2px;
		border:solid 1px var(--gray-med);
		clear:both;
	}
	queue:hover {
		background-color:var(--accent9);
		cursor:pointer;
	}
	steporder {
		display:inline-block;
		width:60px;
		font-size:12px;
		font-weight:bold;
	}
	steporder::before {
		content:'Step ';
	}
	steporder::after {
		content:' Â»';
	}
	stepname {
		display:inline-block;
	}
	samplecount, validationcount {
		float:right;
		position:relative;
		box-sizing:border-box;
		padding:1px;
		top:-2px;
		height:100%;
		margin-left:10px;
		font-size:16px;
		font-weight:bold;
		width:50px;
		text-align:right;
	}
	samplecount {
		color:var(--blue-dark);
	}

	protocolsamples {
		float:right;

	}
	.button-hover-right {
		position:relative;
		width:fit-content;
		border:solid 1px var(--accent5);
		padding:10px;
		padding-right:30px;
	}
	#arrowBox {
	    position: absolute;
		top: 0px;
		right: 0px;
		padding: 0px;
		margin: 0px;
		font-size: 20px;
		background-color: var(--accent3);
		height: 100%;
		width: 20px;
		line-height: 20px;
	}

	#arrowBox::after {
		content: '';
		position:absolute;
		text-rendering: auto;
		-webkit-font-smoothing: antialiased;
		font: var(--fa-font-solid);
		content: "\f0da";
		top: calc(50% - 10px);
		height: 20px;
		width: 12px;
		left: calc(50% - 6px);	
	}

	#hoverBox {
	  display: none;
	  position: absolute;
	  top: 10px;
	  right: -183px; 
	  background-color:var(--inputhover);
	  padding: 10px 0px;
	  width:180px;
	  font-size:16px;
	  border: solid 1px var(--accent7);
	}

	#hoverBox a {
	  display: block;
	  margin: 5px 0;
	  padding:0px 10px;
	}
	
	#hoverBox a:hover {
		background-color:var(--accent3);
		color:#ffffff;
	}
	#arrowBox:hover #hoverBox {
		display:block;
	}
	.project {
		height: 40px;
		border-bottom: solid 1px #cccccc;
		line-height: 40px;
	}
	#new_project_button {
		margin:20px 0px;
	}
    .columns {
        display: flex;
        gap: 20px;
        box-sizing:border-box;
        width:100%;
      }
      
      .column-75 {
        flex: 0 0 calc(75% - 10px);
        
      }
      
      .column-25 {
        flex: 0 0 calc(25% - 10px);
      }
      #queue-info {
        border:solid 1px #000000;
        border-radius:3px;
        font-size:12px;
        font-weight:bold;
        padding:3px;
        margin-bottom:5px;
        position:relative;
        height:22px;
      }
      #view-reserved {
        background-color:var(--green-med);
        border:solid 1px var(--gray-med);
        color:white;
        font-size:16px;
        border-radius:3px;
        width:100%;
        display:block;
        cursor:pointer;
        box-shadow: 1px 1px 4px 0px #0000006b;
        margin-bottom:15px;
      }
      #view-reserved:hover {
        background-color:var(--highlight-green-med);
      }
      .reserved-box {
        background-color:var(--gray-dark);
        border-radius:3px;
        padding:10px 5px;
        border:solid 1px #2a2a2a;
        margin:2px 0px;
        text-align:center;
        position:relative;
      }
      reserve, release, add {
        background-color:var(--blue-med);
        border-radius:2px;
        position: absolute;
        right: 2px;
        top: 2px;
        padding:2px 5px;
        width:70px;
        font-size:14px;
        text-align:center;
        color:white;
        cursor:pointer;
        user-select:none;
      }
      release {
        background-color:var(--gray-med);

      }
      reserve:hover, add:hover {
        cursor:pointer;
        background-color:var(--blue-dark);
      }
      release:hover {
        cursor:pointer;
        background-color:var(--gray-dark);
      }
      add {
        position:relative;
        display:inline-block;
        margin:5px 10px;
      }
      #releaseall {
        font-size:24px;
        position:relative;
      }
      vhr {
        width:100%;
        background-color:var(--gray-med);
        height:1px;
        display:block;
        border-bottom:solid 1px black;
        border-top:var(--gray-dark);
        margin:10px 0px;
      }
      queuedsample {
        margin-left:0px;
        padding:3px 0px;
        width:100%;
      }
      samplenumber, controlnumber {
        width:50px;
        box-sizing:border-box;
        display:inline-block;
      }
      samplenumber::before {
        counter-increment: sample; 
        content: counter(sample) ". "; 
      }
      controlnumber::before {
        counter-increment: control; 
        content: counter(control) ". "; 
      }
      

      #tableheader {
        border:solid 1px #000000;
        border-radius:3px;
        font-size:12px;
        font-weight:bold;
        padding:0px;
        margin-bottom:5px;
        background-color:var(--gray-light);
        display:block;
        position:relative;
      }
      headercontent {
        line-height:20px;
        display:inline-block;
        height:20px;
        padding:0px 10px;
        vertical-align:top;
        text-align:center;
        box-sizing:border-box;
      }
      headerhandle {
        height:20px;
        width:1px;
        background-color:white;
        border-left:solid 1px var(--gray-med);
        border-right:solid 1px var(--gray-light);
        display:inline-block;
        vertical-align:top;
        cursor:ew-resize;
      }
      tablerow {

      }
      samplename {
        width:150px;
      }
      #dragsamples {
         font-size:28px;
         color:white;
      }
      .groupbar {
        background-color: var(--gray-med);
        padding:2px;
        font-weight:bold;
      }

      queuedsample.selectedsample {
        background-color:var(--accent9);
      }
      queuedsample.selectedsample:hover {
        background-color:var(--purple-med-hover);
      }

      sampleoptions {
        position: absolute;
        right: 3px;
        top: 3px;
        background-color: white;
        height: 22px;
        text-align:right;
        line-height: 22px;
        font-size: 14px;
        overflow:hidden;
      }
      sampleoptions:hover {
        overflow:visible;
        z-index:10;
        height:auto;
        box-shadow: 0px 5px 5px 0px #0000004d;
        border-bottom:solid 1px #000000;
      }
      sampleoptions span {
        height: 22px;
        border-radius: 2px;
        line-height: 22px;
        padding: 0px 5px;
        font-size: 14px;
        display:block;
        background-color: var(--gray-light);
        padding: 0px 5px;
        border-radius: 2px;
      }
      sampleoptions div {
        background-color:var(--gray-light);
        margin:3px;
        padding: 0px 5px;
        font-size:12px;
        border-radius: 2px;
      }
      sampleoptions div:hover {
        background-color:var(--accent8);
        cursor:pointer;
      }

      /* User Role Assignment Styles */
      .user-role-container {
        display: flex;
        gap: 20px;
        margin-top: 20px;
        height: 70vh;
      }
      
      /* Create Account Styles */
      .create-account-section {
        background-color: var(--gray-lightest);
        border: 1px solid var(--gray-med);
        border-radius: 5px;
        padding: 20px;
        margin-bottom: 20px;
      }
      
      .create-account-section h3 {
        margin-top: 0;
        margin-bottom: 20px;
        color: var(--gray-darkest);
        border-bottom: 2px solid var(--accent3);
        padding-bottom: 5px;
      }
      
      .create-account-form {
        max-width: 800px;
      }
      
      .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
      }
      
      .form-group {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      
      .form-group label {
        font-weight: bold;
        margin-bottom: 5px;
        color: var(--gray-darkest);
      }
      
      .form-group input {
        padding: 8px 12px;
        border: 1px solid var(--gray-med);
        border-radius: 3px;
        font-size: 14px;
      }
      
      .form-group input:focus {
        outline: none;
        border-color: var(--accent3);
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      }
      
      .roles-checkbox-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-top: 10px;
        padding: 15px;
        background-color: white;
        border: 1px solid var(--gray-med);
        border-radius: 3px;
        min-height: 60px;
      }
      
      .role-checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background-color: var(--gray-lightest);
        border: 1px solid var(--gray-med);
        border-radius: 3px;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      
      .role-checkbox-item:hover {
        background-color: var(--accent9);
      }
      
      .role-checkbox-item input[type="checkbox"] {
        margin: 0;
      }
      
      .form-actions {
        margin-top: 20px;
        display: flex;
        gap: 10px;
      }
      
      .users-section {
        flex: 0 0 40%;
        border: 1px solid var(--gray-med);
        border-radius: 5px;
        padding: 15px;
        background-color: var(--gray-lightest);
      }
      
      .roles-section {
        flex: 1;
        border: 1px solid var(--gray-med);
        border-radius: 5px;
        padding: 15px;
        background-color: var(--gray-lightest);
      }
      
      .users-section h3, .roles-section h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: var(--gray-darkest);
        border-bottom: 2px solid var(--accent3);
        padding-bottom: 5px;
      }
      
      #users-list {
        max-height: calc(100% - 60px);
        overflow-y: auto;
      }
      
      .user-item {
        padding: 12px;
        margin-bottom: 8px;
        border: 1px solid var(--gray-med);
        border-radius: 5px;
        background-color: white;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .user-item:hover {
        background-color: var(--accent9);
        border-color: var(--accent3);
      }
      
      .user-item.selected {
        background-color: var(--accent3);
        color: white;
        border-color: var(--accent5);
      }
      
      .user-name {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 4px;
      }
      
      .user-email {
        font-size: 14px;
        color: var(--gray-dark);
      }
      
      .user-item.selected .user-email {
        color: var(--gray-lightest);
      }
      
      #selected-user-info {
        background-color: var(--blue-lightest);
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
        border-left: 4px solid var(--blue-med);
      }
      
      #roles-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid var(--gray-med);
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        background-color: white;
      }
      
      .role-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 12px;
        padding: 8px;
        border-radius: 3px;
        transition: background-color 0.2s ease;
      }
      
      .role-item:hover {
        background-color: var(--gray-lightest);
      }
      
      .role-item input[type="checkbox"] {
        margin-right: 12px;
        margin-top: 2px;
        transform: scale(1.2);
      }
      
      .role-content {
        flex: 1;
        cursor: pointer;
      }
      
      .role-actions {
        display: flex;
        align-items: center;
        margin-left: 10px;
      }
      
      .role-name {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 4px;
      }
      
      .role-description {
        font-size: 14px;
        color: var(--gray-dark);
        margin-left: 4px;
      }
      
      .btn-primary {
        background-color: var(--blue-med);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-right: 10px;
      }
      
      .btn-primary:hover {
        background-color: var(--blue-dark);
      }
      
      .btn-secondary {
        background-color: var(--gray-med);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }
      
      .btn-secondary:hover {
        background-color: var(--gray-dark);
      }

      .btn-tertiary {
        background-color: var(--pink-med);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
      }
      
      .btn-tertiary:hover {
        background-color: var(--pink-dark);
      }
      
      .loading-message {
        text-align: center;
        color: var(--gray-dark);
        font-style: italic;
        padding: 20px;
      }
      
      .permissions-link {
        color: var(--blue-med);
        cursor: pointer;
        text-decoration: underline;
      }
      
      .permissions-link:hover {
        color: var(--blue-dark);
      }
      
      .permissions-popup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        border: 2px solid var(--gray-med);
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
      }
      
      .permissions-popup-header {
        background-color: var(--accent3);
        color: white;
        padding: 15px 20px;
        border-radius: 6px 6px 0 0;
        font-weight: bold;
        font-size: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      
      .permissions-popup-close {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 0;
        width: 25px;
        height: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .permissions-popup-close:hover {
        background-color: rgba(255, 255, 255, 0.2);
        border-radius: 3px;
      }
      
      .permissions-popup-body {
        padding: 20px;
      }
      
      .permission-item {
        padding: 8px 12px;
        margin-bottom: 6px;
        background-color: var(--gray-lightest);
        border: 1px solid var(--gray-med);
        border-radius: 4px;
        font-size: 14px;
      }
      
      .permission-item:nth-child(odd) {
        background-color: white;
      }
      
      .popup-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
      }
      
      .permission-popup-actions {
        margin-top: 20px;
        padding-top: 15px;
        border-top: 1px solid var(--gray-med);
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }



</style>
{% endblock %}
{% block centercontent %}
<div id="main" class="center-border">
    <breadcrumbs><a href="{% url 'view_settings' %}">Settings</a> / <b><a href="{% url 'settings_operators' %}">Operators</a></b></breadcrumbs>
    
    <!-- Create Account Section -->
    <div class="create-account-section">
        <h3>Create New Account</h3>
        <div class="create-account-form">
            <div class="form-row">
                <div class="form-group">
                    <label for="full-name">Full Name:</label>
                    <input type="text" id="full-name" placeholder="Enter full name">
                </div>
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" id="username" placeholder="Will auto-generate from full name">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" placeholder="Enter email address">
                </div>
            </div>
            <div class="form-group">
                <label>Assign Roles:</label>
                <div id="create-account-roles" class="roles-checkbox-container">
                    <!-- Roles will be loaded here -->
                </div>
            </div>
            <div class="form-actions">
                <button id="create-account-btn" class="btn-primary">Create Account & Send Login Link</button>
                <button id="clear-form-btn" class="btn-secondary">Clear Form</button>
            </div>
        </div>
    </div>
    
    <hr style="margin: 30px 0;">
    
    <div class="user-role-container">
        <div class="users-section">
            <h3>Users</h3>
            <div id="users-list">
                <!-- Users will be loaded here -->
            </div>
        </div>
        
        <div class="roles-section">
            <h3 id="roles-title">Select a user to assign roles</h3>
            <div id="selected-user-info" style="display: none;">
                <p><strong>User:</strong> <span id="selected-user-name"></span></p>
                <p><strong>Email:</strong> <span id="selected-user-email"></span></p>
            </div>
            <div id="roles-list">
                <!-- Roles will be loaded here when a user is selected -->
            </div>
            <div id="role-actions" style="display: none;">
                <button id="save-user-roles" class="btn-primary">Save Roles</button>
                <button id="cancel-role-edit" class="btn-secondary">Cancel</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block javascript %}

<script>
const csrf = '{{ csrf_token }}';
const main = document.getElementById('main');

// State variables
let users = [];
let roles = [];
let selectedUserId = null;
let selectedUserRoles = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadUsers();
    loadRoles();
    setupEventListeners();
});

function setupEventListeners() {
    document.getElementById('save-user-roles').addEventListener('click', saveUserRoles);
    document.getElementById('cancel-role-edit').addEventListener('click', cancelRoleEdit);
    document.getElementById('create-account-btn').addEventListener('click', createAccount);
    document.getElementById('clear-form-btn').addEventListener('click', clearCreateForm);
    
    // Auto-generate username from full name
    document.getElementById('full-name').addEventListener('input', autoGenerateUsername);
}

function loadUsers() {
    const usersList = document.getElementById('users-list');
    usersList.innerHTML = '<div class="loading-message">Loading users...</div>';
    
    // Use Django's database query to get users
    const data = {};
    const pyoptions = {
        data,
        csrf,
        url: '../get_all_users',  // We'll need to create this endpoint
        submit_mode: 'silent'
    };
    
    pylims_post(pyoptions).then(result => {
        if (result.status === 'success') {
            users = result.users;
            displayUsers();
        } else {
            usersList.innerHTML = '<div class="loading-message">Error loading users</div>';
        }
    }).catch(error => {
        console.error('Error loading users:', error);
        usersList.innerHTML = '<div class="loading-message">Error loading users</div>';
    });
}

function loadRoles() {
    const data = {};
    const pyoptions = {
        data,
        csrf,
        url: '../get_all_roles',  // We'll need to create this endpoint
        submit_mode: 'silent'
    };
    
    pylims_post(pyoptions).then(result => {
        if (result.status === 'success') {
            roles = result.roles;
            populateCreateAccountRoles();
        } else {
            console.error('Error loading roles:', result.error);
        }
    }).catch(error => {
        console.error('Error loading roles:', error);
    });
}

function displayUsers() {
    const usersList = document.getElementById('users-list');
    usersList.innerHTML = '';
    
    if (!users || users.length === 0) {
        usersList.innerHTML = '<div class="loading-message">No users found</div>';
        return;
    }
    
    users.forEach(user => {
        const userDiv = document.createElement('div');
        userDiv.className = 'user-item';
        userDiv.setAttribute('data-user-id', user.userid);
        
        userDiv.innerHTML = `
            <div class="user-name">${user.username || 'No username'}</div>
            <div class="user-email">${user.email}</div>
        `;
        
        userDiv.addEventListener('click', () => selectUser(user));
        usersList.appendChild(userDiv);
    });
}

function selectUser(user) {
    selectedUserId = user.userid;
    
    // Update UI to show selected user
    document.querySelectorAll('.user-item').forEach(item => {
        item.classList.remove('selected');
    });
    document.querySelector(`[data-user-id="${user.userid}"]`).classList.add('selected');
    
    // Show user info
    document.getElementById('selected-user-name').textContent = user.username || 'No username';
    document.getElementById('selected-user-email').textContent = user.email;
    document.getElementById('selected-user-info').style.display = 'block';
    document.getElementById('role-actions').style.display = 'block';
    document.getElementById('roles-title').textContent = 'Assign Roles';
    
    // Load user's current roles
    loadUserRoles(user.userid);
}

function loadUserRoles(userId) {
    const data = { user_id: userId };
    const pyoptions = {
        data,
        csrf,
        url: '../get_user_roles',
        submit_mode: 'silent'
    };
    
    pylims_post(pyoptions).then(result => {
        if (result.status === 'success') {
            selectedUserRoles = result.role_ids || [];
            displayRoles();
        } else {
            console.error('Error loading user roles:', result.error);
            selectedUserRoles = [];
            displayRoles();
        }
    }).catch(error => {
        console.error('Error loading user roles:', error);
        selectedUserRoles = [];
        displayRoles();
    });
}

function displayRoles() {
    const rolesList = document.getElementById('roles-list');
    rolesList.innerHTML = '';
    
    if (!roles || roles.length === 0) {
        rolesList.innerHTML = '<div class="loading-message">No roles available</div>';
        return;
    }
    
    roles.forEach(role => {
        const roleDiv = document.createElement('div');
        roleDiv.className = 'role-item';
        
        const isChecked = selectedUserRoles.includes(role.rid);
        
        roleDiv.innerHTML = `
            <input type="checkbox" id="role-${role.rid}" value="${role.rid}" ${isChecked ? 'checked' : ''}>
            <div class="role-content">
                <div class="role-name">${role.role_name}</div>
                <div class="role-description">
                    <span class="permissions-link" data-role-id="${role.rid}" data-role-name="${role.role_name.replace(/'/g, "\\'")}"><i class="fa-solid fa-circle-caret-down"></i> ${getPermissionCount(role.permission_set)} permissions</span>
                    
                </div>
            </div>
        `;
        
        // Add change event listener to checkbox
        const checkbox = roleDiv.querySelector('input[type="checkbox"]');
        checkbox.addEventListener('change', function() {
            const roleId = parseInt(this.value);
            if (this.checked) {
                if (!selectedUserRoles.includes(roleId)) {
                    selectedUserRoles.push(roleId);
                }
            } else {
                selectedUserRoles = selectedUserRoles.filter(id => id !== roleId);
            }
        });
        
        // Add click event listener to role content
        const roleContent = roleDiv.querySelector('.role-content');
        roleContent.addEventListener('click', function(e) {
            // Don't toggle if clicking on permissions link
            if (!e.target.classList.contains('permissions-link')) {
                checkbox.checked = !checkbox.checked;
                checkbox.dispatchEvent(new Event('change'));
            }
        });
        
        // Add click event listener to permissions link
        const permissionsLink = roleDiv.querySelector('.permissions-link');
        permissionsLink.addEventListener('click', function(e) {
            e.stopPropagation();
            const roleId = parseInt(this.dataset.roleId);
            const roleName = this.dataset.roleName;
            const isCurrentlyChecked = checkbox.checked;
            showPermissions(roleId, roleName, isCurrentlyChecked);
        });
        
        rolesList.appendChild(roleDiv);
    });
}

function getPermissionCount(permissionSet) {
    if (!permissionSet) return 0;
    
    let permissions = [];
    if (typeof permissionSet === 'string') {
        try {
            permissions = JSON.parse(permissionSet);
        } catch (e) {
            permissions = [];
        }
    } else if (Array.isArray(permissionSet)) {
        permissions = permissionSet;
    }
    
    return permissions.length;
}

function saveUserRoles() {
    if (!selectedUserId) {
        localerror('No user selected');
        return;
    }
    
    const data = {
        user_id: selectedUserId,
        role_ids: selectedUserRoles
    };
    
    const pyoptions = {
        data,
        csrf,
        url: '../assign_user_roles',
        submit_mode: 'silent'
    };
    
    pylims_post(pyoptions).then(result => {
        if (result.status === 'success') {
            // Show success message
            const successMessage = document.createElement('div');
            successMessage.style.cssText = 'background-color: var(--green-light); color: var(--green-dark); padding: 10px; border-radius: 5px; margin: 10px 0; border: 1px solid var(--green-med);';
            successMessage.textContent = `Successfully assigned ${selectedUserRoles.length} roles to user`;
            document.getElementById('role-actions').appendChild(successMessage);
            
            // Remove success message after 3 seconds
            setTimeout(() => {
                if (successMessage.parentNode) {
                    successMessage.parentNode.removeChild(successMessage);
                }
            }, 3000);
        } else {
            localerror(result.error || 'Failed to save user roles');
        }
    }).catch(error => {
        console.error('Error saving user roles:', error);
        localerror('Error saving user roles: ' + error.message);
    });
}

function cancelRoleEdit() {
    // Clear selection
    selectedUserId = null;
    selectedUserRoles = [];
    
    // Hide UI elements
    document.getElementById('selected-user-info').style.display = 'none';
    document.getElementById('role-actions').style.display = 'none';
    document.getElementById('roles-title').textContent = 'Select a user to assign roles';
    document.getElementById('roles-list').innerHTML = '';
    
    // Clear user selection
    document.querySelectorAll('.user-item').forEach(item => {
        item.classList.remove('selected');
    });
}

function autoGenerateUsername() {
    const fullNameInput = document.getElementById('full-name');
    const usernameInput = document.getElementById('username');
    const fullName = fullNameInput.value.trim();
    
    // Only auto-generate if username field is empty or contains a previously auto-generated value
    // This allows users to manually edit the username without it being overwritten
    const currentUsername = usernameInput.value.trim();
    const shouldAutoGenerate = !currentUsername || currentUsername === usernameInput.dataset.lastGenerated;
    
    if (fullName && shouldAutoGenerate) {
        // Split name into parts and clean them
        const nameParts = fullName.toLowerCase()
            .replace(/[^a-z\s]/g, '') // Remove non-alphabetic characters except spaces
            .split(/\s+/) // Split on whitespace
            .filter(part => part.length > 0); // Remove empty parts
        
        if (nameParts.length >= 2) {
            // Take first initial + last name
            const firstInitial = nameParts[0].charAt(0);
            const lastName = nameParts[nameParts.length - 1];
            const generatedUsername = firstInitial + lastName;
            
            // Store the generated value so we can track if user has manually edited it
            usernameInput.value = generatedUsername;
            usernameInput.dataset.lastGenerated = generatedUsername;
        } else if (nameParts.length === 1) {
            // If only one name part, use it as is
            const generatedUsername = nameParts[0];
            usernameInput.value = generatedUsername;
            usernameInput.dataset.lastGenerated = generatedUsername;
        }
    }
}

function localerror(msg) {
    error_element = document.getElementById('pylims_request_error');
    if (error_element) {
        error_element.textContent = msg;
        error_element.style.display = 'block';
    } else {
        alert(msg); // Fallback if error element doesn't exist
    }
}

function showPermissions(roleId, roleName, isCurrentlyAssigned) {
    // Find the role object to get permission_names
    const role = roles.find(r => r.rid === roleId);
    let permissions = [];
    
    if (role && role.permission_names) {
        permissions = role.permission_names;
    } else {
        // Fallback to parsing permission_set if permission_names not available
        try {
            if (role && role.permission_set) {
                if (typeof role.permission_set === 'string') {
                    permissions = JSON.parse(role.permission_set);
                } else if (Array.isArray(role.permission_set)) {
                    permissions = role.permission_set;
                }
            }
        } catch (e) {
            console.error('Error parsing permissions:', e);
            permissions = [];
        }
    }
    
    // Create popup overlay
    const overlay = document.createElement('div');
    overlay.className = 'popup-overlay';
    overlay.onclick = closePermissionsPopup;
    
    // Create popup container
    const popup = document.createElement('div');
    popup.className = 'permissions-popup';
    popup.id = 'permissions-popup';
    
    // Create popup content
    popup.innerHTML = `
        <div class="permissions-popup-header">
            <span>Permissions for "${roleName}"</span>
            <button class="permissions-popup-close" onclick="closePermissionsPopup()">Ã</button>
        </div>
        <div class="permissions-popup-body">
            ${permissions.length > 0 ? 
                permissions.map(permission => `<div class="permission-item">${permission}</div>`).join('') :
                '<div class="permission-item">No permissions assigned</div>'
            }
            <div class="permission-popup-actions">
                ${!isCurrentlyAssigned ? 
                    `<button class="btn-primary" onclick="assignRoleFromPopup(${roleId})">Assign Role</button>` :
                    `<button class="btn-tertiary" onclick="unassignRoleFromPopup(${roleId})">Remove Role</button>`
                }
                <button class="btn-secondary" onclick="closePermissionsPopup()">Cancel</button>
            </div>
        </div>
    `;
    
    // Add to page
    document.body.appendChild(overlay);
    document.body.appendChild(popup);
    
    // Prevent event bubbling
    popup.onclick = function(e) {
        e.stopPropagation();
    };
}

function closePermissionsPopup() {
    const overlay = document.querySelector('.popup-overlay');
    const popup = document.getElementById('permissions-popup');
    
    if (overlay) {
        document.body.removeChild(overlay);
    }
    if (popup) {
        document.body.removeChild(popup);
    }
}

// Close popup on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closePermissionsPopup();
    }
});

function assignRoleFromPopup(roleId) {
    // Find and check the checkbox
    const checkbox = document.querySelector(`#role-${roleId}`);
    if (checkbox && !checkbox.checked) {
        checkbox.checked = true;
        checkbox.dispatchEvent(new Event('change'));
    }
    closePermissionsPopup();
}

function unassignRoleFromPopup(roleId) {
    // Find and uncheck the checkbox
    const checkbox = document.querySelector(`#role-${roleId}`);
    if (checkbox && checkbox.checked) {
        checkbox.checked = false;
        checkbox.dispatchEvent(new Event('change'));
    }
    closePermissionsPopup();
}

function populateCreateAccountRoles() {
    const container = document.getElementById('create-account-roles');
    container.innerHTML = '';
    
    if (!roles || roles.length === 0) {
        container.innerHTML = '<div style="color: var(--gray-dark); font-style: italic;">No roles available</div>';
        return;
    }
    
    roles.forEach(role => {
        const roleDiv = document.createElement('div');
        roleDiv.className = 'role-checkbox-item';
        
        roleDiv.innerHTML = `
            <input type="checkbox" id="create-role-${role.rid}" value="${role.rid}">
            <label for="create-role-${role.rid}">${role.role_name}</label>
        `;
        
        container.appendChild(roleDiv);
    });
}

function createAccount() {
    console.log('=== CREATE ACCOUNT DEBUG START ===');
    
    const fullName = document.getElementById('full-name').value.trim();
    const username = document.getElementById('username').value.trim();
    const email = document.getElementById('email').value.trim();
    
    console.log('Form values:');
    console.log('- Full Name:', fullName);
    console.log('- Username:', username);
    console.log('- Email:', email);
    
    // Validate required fields
    if (!fullName) {
        console.log('ERROR: Full name is required');
        localerror('Full name is required');
        return;
    }
    
    if (!username) {
        console.log('ERROR: Username is required');
        localerror('Username is required');
        return;
    }
    
    if (!email) {
        console.log('ERROR: Email is required');
        localerror('Email is required');
        return;
    }
    
    // Basic email validation
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
        console.log('ERROR: Invalid email format');
        localerror('Please enter a valid email address');
        return;
    }
    
    // Check if username or email already exists
    console.log('Checking for existing users...');
    const existingUser = users.find(user => 
        user.username === username || user.email === email
    );
    
    if (existingUser) {
        console.log('ERROR: User already exists:', existingUser);
        if (existingUser.username === username && existingUser.email === email) {
            localerror(`Both username "${username}" and email "${email}" are already in use.`);
        } else if (existingUser.username === username) {
            localerror(`Username "${username}" is already in use. Please choose a different username.`);
        } else {
            localerror(`Email "${email}" is already in use. Please use a different email address.`);
        }
        return;
    }
    
    console.log('No existing users found with that username or email.');
    
    // Get selected roles
    const selectedRoles = [];
    const roleCheckboxes = document.querySelectorAll('#create-account-roles input[type="checkbox"]:checked');
    console.log('Role checkboxes found:', roleCheckboxes.length);
    
    roleCheckboxes.forEach(checkbox => {
        const roleId = parseInt(checkbox.value);
        console.log('- Selected role ID:', roleId);
        selectedRoles.push(roleId);
    });
    
    const data = {
        full_name: fullName,
        username: username,
        email: email,
        role_ids: selectedRoles
    };
    
    console.log('Data to be sent:');
    console.log(JSON.stringify(data, null, 2));
    
    const pyoptions = {
        data,
        csrf,
        url: '../create_account',
        submit_mode: 'silent'
    };
    
    console.log('PyLIMS options:');
    console.log('- URL:', pyoptions.url);
    console.log('- CSRF:', csrf);
    console.log('- Submit mode:', pyoptions.submit_mode);
    
    // Disable button during creation
    const createBtn = document.getElementById('create-account-btn');
    createBtn.disabled = true;
    createBtn.textContent = 'Creating Account...';
    
    console.log('Making pylims_post request...');
    
    pylims_post(pyoptions).then(result => {
        console.log('PyLIMS response received:');
        console.log(JSON.stringify(result, null, 2));
        
        if (result.status === 'success') {
            console.log('SUCCESS: Account created successfully');
            
            // Show success message
            const successMessage = document.createElement('div');
            successMessage.style.cssText = 'background-color: var(--green-light); color: var(--green-dark); padding: 15px; border-radius: 5px; margin: 15px 0; border: 1px solid var(--green-med);';
            
            // Determine email status message
            let emailStatusMsg = '';
            if (result.email_status === 'sent successfully') {
                emailStatusMsg = `<small style="color: var(--green-dark);"><i class="fa-solid fa-check-circle"></i> Login email sent successfully to ${email}. User can click the link to activate account.</small>`;
            } else {
                emailStatusMsg = `<small style="color: var(--orange-dark);"><i class="fa-solid fa-exclamation-triangle"></i> Account created but email failed to send. Direct login link: <a href="http://localhost:8000/login/${result.login_code}" target="_blank">http://localhost:8000/login/${result.login_code}</a></small>`;
            }
            
            successMessage.innerHTML = `
                <strong>Account Created Successfully!</strong><br>
                User: ${fullName} (${username})<br>
                Email: ${email}<br>
                Roles: ${result.role_ids ? result.role_ids.length : 0} assigned<br>
                ${emailStatusMsg}
            `;
            
            document.querySelector('.create-account-form').appendChild(successMessage);
            
            // Clear form
            clearCreateForm();
            
            // Refresh users list
            loadUsers();
            
            // Remove success message after 10 seconds
            setTimeout(() => {
                if (successMessage.parentNode) {
                    successMessage.parentNode.removeChild(successMessage);
                }
            }, 10000);
        } else {
            console.log('ERROR: Server returned error');
            console.log('Error message:', result.error);
            
            // Handle specific error types with better messaging
            if (result.error === 'Username or email already exists') {
                localerror(`Account creation failed: A user with username "${username}" or email "${email}" already exists. Please use a different username or email.`);
            } else {
                localerror(result.error || 'Failed to create account');
            }
        }
    }).catch(error => {
        console.log('CATCH: Request failed');
        console.error('Full error object:', error);
        console.error('Error message:', error.message);
        console.error('Error stack:', error.stack);
        localerror('Error creating account: ' + error.message);
    }).finally(() => {
        console.log('FINALLY: Re-enabling button');
        // Re-enable button
        createBtn.disabled = false;
        createBtn.textContent = 'Create Account & Send Login Link';
    });
    
    console.log('=== CREATE ACCOUNT DEBUG END ===');
}

function clearCreateForm() {
    document.getElementById('full-name').value = '';
    document.getElementById('username').value = '';
    document.getElementById('email').value = '';
    
    // Clear auto-generation tracking
    document.getElementById('username').dataset.lastGenerated = '';
    
    // Uncheck all role checkboxes
    document.querySelectorAll('#create-account-roles input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
    });
}

</script>{% endblock %}